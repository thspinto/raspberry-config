# This playbook create the initial secure setup for rbp
---

- hosts: "rbp"
  become: yes

  pre_tasks:
  - name: "install python3-pip"
    apt:
      pkg: python3-pip
      state: present

  roles:
  - role: geerlingguy.docker_arm
    tags:
      - docker

  tasks:
  - name: "Mount extra storage"
    mount:
      path: /mnt/storage
      src: /dev/sda
      fstype: ext4
      state: mounted

  - name: "Drop the pi user"
    user:
      name: pi
      state: absent
      remove: yes

  - name: "Timezone"
    timezone:
      name: "America/Sao_Paulo"

  - name: "Update and remove unneeded packages"
    block:
      - apt:
          update_cache: yes
          upgrade: dist
      - apt:
          autoremove: yes

  - import_tasks: tasks/fail2ban.yaml
    tags: fail2ban

  - import_tasks: tasks/unattended.yaml

    tags: unattended

  - import_tasks: tasks/firewall.yaml
    tags: firewall

  - import_tasks: tasks/docker.yaml
    tags: docker

  - import_tasks: tasks/cloudflare_ddns.yaml
    tags: ddns
